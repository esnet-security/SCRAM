---

services:
  django:
    build:
      context: .
      dockerfile: ./compose/production/django/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    command: /start
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 2s
      start_period: 30s
      retries: 5
    deploy:
      replicas: ${DJANGO_REPLICAS:-1}

  django-secondary:
    build:
      context: .
      dockerfile: ./compose/production/django/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      django:
        condition: service_healthy
      celery-worker-secondary:
        condition: service_healthy
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    command: /start
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 2s
      start_period: 30s
      retries: 5
    deploy:
      replicas: ${DJANGO_REPLICAS:-0}

  postgres:
    build:
      context: .
      dockerfile: ./compose/production/postgres/Dockerfile
    image: scram_production_postgres
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    deploy:
      replicas: ${POSTGRES_ENABLED:-0}

  redis:
    image: redis:8.2.2
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
    deploy:
      replicas: ${REDIS_REPLICAS:-1}

  gobgp:
    image: jauderho/gobgp:v3.37.0
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    healthcheck:
      test: ["CMD", "gobgp", "global"]
    deploy:
      replicas: ${GOBGP_REPLICAS:-1}

  gobgp-secondary:
    image: jauderho/gobgp:v3.33.0
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    healthcheck:
      test: ["CMD", "gobgp", "global"]
    deploy:
      replicas: ${GOBGP_REPLICAS:-0}

  translator:
    build:
      context: .
      dockerfile: ./compose/local/translator/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      gobgp:
        condition: service_healthy
      django:
        condition: service_healthy
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    deploy:
      replicas: ${TRANSLATOR_REPLICAS:-1}

  translator-secondary:
    build:
      context: .
      dockerfile: ./compose/local/translator/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      gobgp-secondary:
        condition: service_healthy
      django-secondary:
        condition: service_healthy
    networks:
      default: {}
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    deploy:
      replicas: ${TRANSLATOR_REPLICAS:-0}

  celery-worker:
    build:
      context: .
      dockerfile: ./compose/production/celery/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "celery", "-A", "scheduler.app:scram_api_scheduler", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped

  celery-worker-secondary:
    build:
      context: .
      dockerfile: ./compose/production/celery/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "celery", "-A", "scheduler.app:scram_api_scheduler", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    deploy:
      replicas: ${CELERY_WORKER_REPLICAS:-0}

  celery-beat:
    build:
      context: .
      dockerfile: ./compose/production/celery/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    restart: unless-stopped

  celery-beat-secondary:
    build:
      context: .
      dockerfile: ./compose/production/celery/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      celery-worker-secondary:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: ${CELERY_BEAT_REPLICAS:-0}

  flower:
    build:
      context: .
      dockerfile: ./compose/production/celery/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  flower-secondary:
    build:
      context: .
      dockerfile: ./compose/production/celery/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
      celery-worker-secondary:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    deploy:
      replicas: ${FLOWER_REPLICAS:-0}
